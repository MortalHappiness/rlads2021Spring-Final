---
title: "Google map review analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries

```{r}
library(tidyverse)
library(ggplot2)
library(showtext)
showtext_auto()
```

## Review Tfidf graph

```{r}
review_tfidf <- readRDS("../Rdata/reviews_tfidf.rds")

# calculate the tfidf for a specific place and ratings
tfidf_filter <- function (place, ratings) {
  filtered <- review_tfidf %>%
    filter(place == !!place, rating %in% !!ratings) %>%
    group_by(word) %>%
    select(word, tf_idf) %>%
    summarize(tf_idf = sum(tf_idf)) %>%
    arrange(desc(tf_idf)) %>%
    ungroup() %>%
    slice_max(tf_idf, n = 15)
  return(filtered)
}

res <- tfidf_filter("ChIJldrqooqpQjQRl4bCVhVRvuI", c(4, 5))
res %>%
  ggplot(aes(x = tf_idf, y = fct_reorder(word, tf_idf))) +
  geom_col()
```

## Rating Tfidf graph

```{r}
library(tidytext)

stopword <- read.delim("../stopword.txt")

reviews_df <- readRDS("../Rdata/reviews_jeiba.rds")

review_tidy <- reviews_df %>%
  unnest_tokens(
    output = "word",
    input = "text",
    token = "regex",
    pattern = "\u3000"
  )

review_without_stopword <- review_tidy %>%
  filter(! word %in% stopword$X) %>%
  count(rating, word) %>%
  bind_tf_idf(word, rating, n) %>%
  arrange(desc(n))

# plot by frequency
review_without_stopword %>%
  group_by(rating) %>%
  slice_max(n, n = 15) %>%
  ungroup() %>%
  ggplot(aes(n, fct_reorder(word, n, sum), fill = rating)) +
  geom_col(show.legend = FALSE) +
  labs(x = "Frequency", y = NULL)

```

## Type rating

```{r}
place_df <- readRDS("../Rdata/places.rds")

place_df %>%
  separate_rows(types, sep = ",", convert = TRUE) %>%
  group_by(types) %>%
  summarize(n = n(),
            avg = mean(rating),
            std = sd(rating)) %>%
  arrange(desc(n))

# plot the rating distribution of every types of places
place_df %>%
  filter(!is.na(rating)) %>%
  separate(types, c("first_type"), sep=",") %>%
  ggplot(aes(x=fct_reorder(as.factor(first_type), rating), y=rating)) +
  geom_boxplot()

```