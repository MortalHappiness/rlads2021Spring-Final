---
title: "Google map review analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries

```{r}
library(tidyverse)
library(ggplot2)
```

## Review Tfidf graph

```{r}
review_tfidf <- readRDS("../Rdata/reviews_tfidf.rds")

tfidf_filter <- function (place, ratings) {
  filtered <- review_tfidf %>%
    filter(place == !!place, rating %in% !!ratings) %>%
    group_by(word) %>%
    select(word, tf_idf) %>%
    summarize(tf_idf = sum(tf_idf)) %>%
    arrange(desc(tf_idf)) %>%
    ungroup() %>%
    slice_max(tf_idf, n = 15)
  return(filtered)
}

res <- tfidf_filter("ChIJldrqooqpQjQRl4bCVhVRvuI", c(4, 5))
res %>%
  ggplot(aes(x = tf_idf, y = fct_reorder(word, tf_idf))) +
  geom_col()
```

## Type rating

```{r}
place_df <- readRDS("../Rdata/places.rds")

place_df %>%
  separate_rows(types, sep = ",", convert = TRUE) %>%
  group_by(types) %>%
  summarize(n = n(),
            avg = mean(rating),
            std = sd(rating)) %>%
  arrange(desc(n))
```

```{r}
# USAGE:
#   input a word you want to analyze and will print out the positive/negative/total
#   comments, and the slice_max returns the most apparent performance of num places

reviews_with_name <- readRDS("../Rdata/review_jieba_with_name.rds")

words_filter <- function(word = '燈光', tag = 'pos', num = 25) {
  filtered <- reviews_with_name %>%
    filter(grepl(word, text)) %>%
    group_by(name) %>%
    summarise(pos = sum(rating %in% c(4,5)), neg = sum(rating %in% c(1,3)))
  
  if (tag == 'pos') {
    filtered <- filtered %>% 
      slice_max(pos, n = num)
  } else if (tag == 'neg') {
     filtered <- filtered %>% 
      slice_max(neg, n = num)
  } else if (tag == 'total') {
     filtered <- filtered %>% 
      slice_max(pos+neg, n = num)
  }
  
  return(filtered)
}

res <- words_filter(word = '衛生', tag = 'pos', num = 25)

# the y should be two tags, I will fix this when showing in the web page
res %>%
  ggplot(aes(x = name, y = pos)) +
  geom_col()

```